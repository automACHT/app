<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nieuw Item - Autom8</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="framework/framework.css">
    <link rel="stylesheet" href="createRecipe.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <meta name="theme-color" content="#FF5733" id="themeColor">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Autom8">
</head>

<body>
    <header class="header recipe-header">
        <div class="header-container">
            <!-- Terug button -->
            <button class="header-btn back-btn" onclick="handleBackNavigation(event); return false;" title="Terug">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>

            <!-- Titel -->
            <div class="page-title">
                <div class="page-icon">
                    <span class="material-symbols-outlined" id="pageIcon">add</span>
                </div>
                <h1 id="pageTitle">Nieuw Item</h1>
            </div>

            <!-- Acties -->
            <div class="header-actions">
                <button class="header-btn save-btn" id="saveBtn" title="Opslaan">
                    <span class="material-symbols-outlined">save</span>
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <!-- Loading state -->
        <div class="loading-state" id="loadingState" style="display: none;">
            <div class="loading-spinner"></div>
        </div>

        <!-- Form container -->
        <div id="formContainer">
            <!-- Framework genereert hier het formulier -->
        </div>
    </main>

    <!-- Floating Action Buttons -->
    <div class="fab-group">
        <button class="fab fab-secondary" onclick="handleBackNavigation(event); return false;" title="Annuleren">
            <span class="material-symbols-outlined">close</span>
        </button>
        <button class="fab fab-primary" id="saveFab" title="Item opslaan">
            <span class="material-symbols-outlined">save</span>
        </button>
    </div>

    <!-- Framework Scripts -->
    <script src="framework/ModuleFramework.js"></script>
    <script src="framework/ModuleViewGenerator.js"></script>
    <script src="framework/ModulePageController.js"></script>

    <!-- Module Script -->
    <script>
        let controller;

        // Handle back navigation specifiek voor grocery lists
        function handleBackNavigation(event) {
            console.log('createRecipe handleBackNavigation called');
            console.log('Current URL:', window.location.href);
            
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category');
            
            console.log('Category:', category);
            
            if (category === 'grocerylist') {
                console.log('Navigating from createRecipe to grocery list');
                window.location.replace('recipes.html?category=grocerylist&view=list');
            } else {
                console.log('Navigating from createRecipe to recipes');
                window.location.replace('recipes.html');
            }
            
            return false;
        }

        // Bepaal welke configuratie te gebruiken op basis van URL parameter
        function getConfigPath() {
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category');
            
            switch(category) {
                case 'grocerylist':
                    return './config/conf.grocerylist.json';
                case 'recipe':
                default:
                    return './config/conf.recipe.json';
            }
        }

        // Update page styling en titel op basis van categorie
        function updatePageForCategory(config) {
            // Update theme color
            const themeColorMeta = document.getElementById('themeColor');
            if (themeColorMeta && config['theme-color']) {
                themeColorMeta.setAttribute('content', config['theme-color']);
            }

            // Update page title en icon
            const pageTitle = document.getElementById('pageTitle');
            const pageIcon = document.getElementById('pageIcon');
            
            if (config.category === 'Grocery List') {
                document.title = 'Nieuwe Boodschappenlijst - Autom8';
                if (pageTitle) pageTitle.textContent = 'Nieuwe Boodschappenlijst';
                if (pageIcon) pageIcon.textContent = 'shopping_cart';
            } else if (config.category === 'Recipes') {
                document.title = 'Nieuw Recept - Autom8';
                if (pageTitle) pageTitle.textContent = 'Nieuw Recept';
                if (pageIcon) pageIcon.textContent = 'restaurant';
            }
        }

        // Debug functie om config te testen
        async function debugConfig() {
            const configPath = getConfigPath();
            console.log('Config path:', configPath);
            
            try {
                const response = await fetch(configPath);
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                console.log('Raw response:', text);
                
                const config = JSON.parse(text);
                console.log('Parsed config:', config);
                
                return config;
            } catch (error) {
                console.error('Debug config error:', error);
                return null;
            }
        }

        // Initialize module controller
        async function initModule() {
            try {
                // Debug de config eerst
                console.log('Starting debug config...');
                await debugConfig();
                
                const configPath = getConfigPath();
                console.log('Loading config from:', configPath);
                
                controller = new ModulePageController(configPath);
                
                const success = await controller.init();
                console.log('Init success:', success);
                
                if (!success) {
                    throw new Error('Module initialisatie gefaald');
                }

                // Controleer of config geladen is
                if (!controller.config) {
                    console.error('Controller:', controller);
                    console.error('Controller.framework:', controller.framework);
                    console.error('Controller.framework.config:', controller.framework?.config);
                    throw new Error('Configuratie niet geladen');
                }

                console.log('Config geladen:', controller.config);

                // Update page voor de juiste categorie
                updatePageForCategory(controller.config);

                // Bepaal view op basis van URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('edit');
                
                if (editId) {
                    // Edit mode
                    controller.showEditView(editId);
                    
                    // Update page title voor edit mode
                    const pageTitle = document.getElementById('pageTitle');
                    if (pageTitle) {
                        if (controller.config.category === 'Grocery List') {
                            pageTitle.textContent = 'Boodschappenlijst bewerken';
                            document.title = 'Boodschappenlijst bewerken - Autom8';
                        } else {
                            pageTitle.textContent = 'Recept bewerken';
                            document.title = 'Recept bewerken - Autom8';
                        }
                    }
                } else {
                    // Create mode
                    controller.showCreateView();
                }
                
                console.log('Module succesvol ge√Ønitialiseerd voor', controller.config.category);
            } catch (error) {
                console.error('Module initialisatie fout:', error);
                
                // Toon meer specifieke foutmelding
                let errorMessage = 'Er is een fout opgetreden bij het laden van het formulier.';
                if (error.message.includes('Configuratie niet geladen')) {
                    errorMessage = 'Kan configuratie bestand niet laden. Controleer of het bestand bestaat.';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('HTTP 404')) {
                    errorMessage = 'Configuratie bestand niet gevonden. Maak eerst het conf.grocerylist.json bestand aan.';
                } else if (error.message.includes('JSON')) {
                    errorMessage = 'Configuratie bestand bevat ongeldige JSON.';
                }
                
                document.getElementById('formContainer').innerHTML = `
                    <div class="error-state">
                        <h2>Fout bij laden</h2>
                        <p>${errorMessage}</p>
                        <p><small>Details: ${error.message}</small></p>
                        <button onclick="location.reload()">Opnieuw proberen</button>
                        <button onclick="handleBackNavigation()">Terug</button>
                    </div>
                `;
            }
        }

        // Setup event handlers
        function setupEventHandlers() {
            // Bepaal de terug-URL op basis van categorie
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category');
            
            let backUrl = 'recipes.html'; // default
            if (category === 'grocerylist') {
                backUrl = 'recipes.html?category=grocerylist';
            }

            // Override back button
            const backButtons = document.querySelectorAll('.back-btn, .fab-secondary');
            backButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.href = backUrl;
                });
            });
        }

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', () => {
            setupEventHandlers();
            initModule();
        });

        // Legacy support voor oude callbacks (als nog ergens gebruikt)
        window.saveRecipe = async function() {
            if (controller) {
                await controller.handleSave();
            }
        };
    </script>
</body>

</html>
