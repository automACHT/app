<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Items - Autom8</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="framework/framework.css">
    <link rel="stylesheet" href="recipes.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <meta name="theme-color" content="#FF5733" id="themeColor">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Autom8">
</head>

<body>
    <header class="header recipes-header">
        <div class="header-container">
            <!-- Terug button -->
            <button class="header-btn back-btn" onclick="handleBackNavigation(event); return false;" title="Terug">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>

            <!-- Titel -->
            <div class="page-title">
                <div class="page-icon">
                    <span class="material-symbols-outlined" id="pageIcon">restaurant</span>
                </div>
                <h1 id="pageTitle">Items</h1>
            </div>

            <!-- Zoeken en filteren -->
            <div class="header-actions">
                <button class="header-btn filter-btn" id="filterBtn" title="Filteren">
                    <span class="material-symbols-outlined">tune</span>
                </button>
                <button class="header-btn search-btn" id="searchBtn" title="Zoeken">
                    <span class="material-symbols-outlined">search</span>
                </button>
                <button class="header-btn create-btn" id="createBtn" title="Nieuw item">
                    <span class="material-symbols-outlined">add</span>
                </button>
            </div>
        </div>

        <!-- Zoekbalk en filters -->
        <div id="searchContainer" style="display: none;">
            <!-- Framework genereert hier search en filter controls -->
        </div>
    </header>

    <main class="main-content">
        <!-- Loading state -->
        <div class="loading-state" id="loadingState" style="display: none;">
            <div class="loading-spinner"></div>
            <p id="loadingText">Items worden geladen...</p>
        </div>

        <!-- Main content container -->
        <div id="mainContent">
            <!-- Framework genereert hier de recepten lijst -->
        </div>
    </main>

    <!-- Floating Action Button -->
    <button class="fab" id="createFab" title="Nieuw item toevoegen">
        <span class="material-symbols-outlined">add</span>
    </button>

    <!-- Framework Scripts -->
    <script src="framework/ModuleFramework.js"></script>
    <script src="framework/ModuleViewGenerator.js"></script>
    <script src="framework/ModulePageController.js"></script>

    <!-- Module Script -->
    <script>
        let controller;

        // Handle back navigation specifiek voor grocery lists
        function handleBackNavigation() {
            console.log('handleBackNavigation called');
            console.log('Current URL:', window.location.href);
            console.log('URL params:', window.location.search);
            
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category');
            
            console.log('Category:', category);
            
            // Stop alle mogelijke framework interventies
            event.preventDefault();
            event.stopPropagation();
            
            // Forceer navigatie naar main ongeacht de parameters
            if (window.location.search.includes('grocerylist')) {
                console.log('Forcing navigation to main.html');
                window.location.replace('main.html');
            } else {
                console.log('Regular navigation to main.html');
                window.location.replace('main.html');
            }
            
            return false;
        }

        // Bepaal welke configuratie te gebruiken op basis van URL parameter
        function getConfigPath() {
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category');
            
            switch(category) {
                case 'grocerylist':
                    return './config/conf.grocerylist.json';
                case 'recipe':
                default:
                    return './config/conf.recipe.json';
            }
        }

        // Update page styling en titel op basis van categorie
        function updatePageForCategory(config) {
            // Update theme color
            const themeColorMeta = document.getElementById('themeColor');
            if (themeColorMeta && config['theme-color']) {
                themeColorMeta.setAttribute('content', config['theme-color']);
            }

            // Update page title en icon
            const pageTitle = document.getElementById('pageTitle');
            const pageIcon = document.getElementById('pageIcon');
            const loadingText = document.getElementById('loadingText');
            
            if (config.category === 'Grocery List') {
                document.title = 'Boodschappenlijsten - Autom8';
                if (pageTitle) pageTitle.textContent = 'Boodschappenlijsten';
                if (pageIcon) pageIcon.textContent = 'shopping_cart';
                if (loadingText) loadingText.textContent = 'Boodschappenlijsten worden geladen...';
            } else if (config.category === 'Recipes') {
                document.title = 'Recepten - Autom8';
                if (pageTitle) pageTitle.textContent = 'Recepten';
                if (pageIcon) pageIcon.textContent = 'restaurant';
                if (loadingText) loadingText.textContent = 'Recepten worden geladen...';
            }
        }

        // Initialize module
        async function initModule() {
            try {
                const configPath = getConfigPath();
                controller = new ModulePageController(configPath);
                
                const success = await controller.init();
                if (!success) {
                    throw new Error('Module initialisatie gefaald');
                }

                // Update page voor de juiste categorie
                if (controller.config) {
                    updatePageForCategory(controller.config);
                }

                // Setup callbacks voor navigatie
                const urlParams = new URLSearchParams(window.location.search);
                const category = urlParams.get('category');
                
                controller.framework.on('view', (item) => {
                    if (category === 'grocerylist') {
                        // Voor grocery lists - ga naar edit met view parameter
                        window.location.href = `createRecipe.html?category=grocerylist&view=create&edit=${item.id}`;
                    } else {
                        // Voor recipes
                        window.location.href = `recipeDetail.html?id=${item.id}`;
                    }
                });

                controller.framework.on('edit', (item) => {
                    if (category === 'grocerylist') {
                        window.location.href = `createRecipe.html?category=grocerylist&view=create&edit=${item.id}`;
                    } else {
                        window.location.href = `createRecipe.html?edit=${item.id}`;
                    }
                });

                // Show lijst view
                controller.showListView();
                
                console.log('Module succesvol ge√Ønitialiseerd voor', controller.config.category);
            } catch (error) {
                console.error('Module initialisatie fout:', error);
                document.getElementById('mainContent').innerHTML = `
                    <div class="error-state">
                        <h2>Fout bij laden</h2>
                        <p>Er is een fout opgetreden bij het laden van de items.</p>
                        <button onclick="location.reload()">Opnieuw proberen</button>
                    </div>
                `;
            }
        }

        // Setup additional event handlers
        function setupEventHandlers() {
            // FORCE override van back button met priority event listener
            const backBtn = document.querySelector('.back-btn');
            if (backBtn) {
                // Verwijder alle bestaande event listeners door de button te vervangen
                const newBackBtn = backBtn.cloneNode(true);
                backBtn.parentNode.replaceChild(newBackBtn, backBtn);
                
                // Voeg nieuwe event listener toe met capture=true voor priority
                newBackBtn.addEventListener('click', function(e) {
                    console.log('Event listener back button clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('category') === 'grocerylist') {
                        console.log('Event listener: Navigating to main from grocery list');
                        window.location.replace('main.html');
                    } else {
                        console.log('Event listener: Navigating to main from recipes');
                        window.location.replace('main.html');
                    }
                    
                    return false;
                }, true); // capture=true gives this priority
            }

            // Bepaal de create URL op basis van categorie
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category');
            
            let createUrl = 'createRecipe.html'; // default
            if (category === 'grocerylist') {
                createUrl = 'createRecipe.html?category=grocerylist&view=create';
            }

            // Create button
            const createBtn = document.getElementById('createBtn');
            const createFab = document.getElementById('createFab');
            
            [createBtn, createFab].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        window.location.href = createUrl;
                    });
                }
            });

            // Search toggle
            const searchBtn = document.getElementById('searchBtn');
            const searchContainer = document.getElementById('searchContainer');
            
            if (searchBtn && searchContainer) {
                searchBtn.addEventListener('click', () => {
                    const isVisible = searchContainer.style.display !== 'none';
                    searchContainer.style.display = isVisible ? 'none' : 'block';
                    
                    // Focus on search input when showing
                    if (!isVisible) {
                        setTimeout(() => {
                            const searchInput = searchContainer.querySelector('.search-input');
                            if (searchInput) searchInput.focus();
                        }, 100);
                    }
                });
            }

            // Filter toggle (legacy support)
            const filterBtn = document.getElementById('filterBtn');
            if (filterBtn) {
                filterBtn.addEventListener('click', () => {
                    // Toggle search container which now includes filters
                    const searchContainer = document.getElementById('searchContainer');
                    if (searchContainer) {
                        const isVisible = searchContainer.style.display !== 'none';
                        searchContainer.style.display = isVisible ? 'none' : 'block';
                    }
                });
            }
        }

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', () => {
            setupEventHandlers();
            initModule();
        });

        // Legacy support voor oude callbacks (als nog ergens gebruikt)
        window.viewRecipe = function(id) {
            window.location.href = `recipeDetail.html?id=${id}`;
        };

        window.editRecipe = function(id) {
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category');
            
            if (category === 'grocerylist') {
                window.location.href = `createRecipe.html?category=grocerylist&view=create&edit=${id}`;
            } else {
                window.location.href = `createRecipe.html?edit=${id}`;
            }
        };
    </script>
</body>

</html>
